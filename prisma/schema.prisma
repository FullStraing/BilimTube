// Prisma schema for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String         @id @default(cuid())
  email        String?        @unique
  phone        String?        @unique
  googleId     String?        @unique
  passwordHash String?
  accountType  AccountType
  authMethod   AuthMethod
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  sessions     Session[]
  children     ChildProfile[]
  favorites    Favorite[]
  watchHistory WatchHistory[]
  shortViews   ShortView[]
  quizAttempts QuizAttempt[]
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChildProfile {
  id               String   @id @default(cuid())
  userId           String
  name             String
  age              Int
  avatarColor      String
  interests        String[]
  dailyLimitMinutes Int      @default(120)
  educationalOnly  Boolean  @default(false)
  allowedAgeGroups String[] @default(["4-6", "7-9", "10-13"])
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  favorites        Favorite[]
  watchHistory     WatchHistory[]
  shortViews       ShortView[]
  quizAttempts     QuizAttempt[]

  @@index([userId])
}

model Video {
  id           String     @id @default(cuid())
  slug         String     @unique
  title        String
  description  String
  category     String
  ageGroup     String
  thumbnailUrl String
  videoUrl     String
  contentType  ContentType @default(LONG)
  durationSec  Int
  viewsCount   Int        @default(0)
  isPublished  Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  favorites    Favorite[]
  watchHistory WatchHistory[]
  shortViews   ShortView[]
  quiz         Quiz?

  @@index([contentType, isPublished, createdAt])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  childId   String?
  videoId   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  child     ChildProfile? @relation(fields: [childId], references: [id], onDelete: SetNull)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, childId, videoId])
  @@index([userId, childId])
  @@index([videoId])
}

model WatchHistory {
  id        String   @id @default(cuid())
  userId    String
  childId   String?
  videoId   String
  watchedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  child     ChildProfile? @relation(fields: [childId], references: [id], onDelete: SetNull)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, childId, videoId])
  @@index([userId, childId, watchedAt])
  @@index([videoId])
}

model ShortView {
  id        String    @id @default(cuid())
  userId    String
  childId   String?
  videoId   String
  watchedMs Int       @default(0)
  completed Boolean   @default(false)
  viewedAt  DateTime  @default(now())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  child     ChildProfile? @relation(fields: [childId], references: [id], onDelete: SetNull)
  video     Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, childId, videoId])
  @@index([userId, childId, viewedAt])
  @@index([videoId, viewedAt])
}

model Quiz {
  id          String         @id @default(cuid())
  videoId     String         @unique
  title       String
  description String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  video       Video          @relation(fields: [videoId], references: [id], onDelete: Cascade)
  questions   QuizQuestion[]
  attempts    QuizAttempt[]
}

model QuizQuestion {
  id        String       @id @default(cuid())
  quizId    String
  text      String
  sortOrder Int
  quiz      Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options   QuizOption[]
  answers   QuizAnswer[]

  @@index([quizId, sortOrder])
}

model QuizOption {
  id         String       @id @default(cuid())
  questionId String
  text       String
  sortOrder  Int
  isCorrect  Boolean      @default(false)
  question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers    QuizAnswer[] @relation("SelectedOption")

  @@index([questionId, sortOrder])
}

model QuizAttempt {
  id         String       @id @default(cuid())
  quizId     String
  userId     String
  childId    String?
  score      Int
  maxScore   Int
  percentage Int
  createdAt  DateTime     @default(now())
  quiz       Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  child      ChildProfile? @relation(fields: [childId], references: [id], onDelete: SetNull)
  answers    QuizAnswer[]

  @@index([userId, childId, createdAt])
  @@index([quizId, createdAt])
}

model QuizAnswer {
  id               String       @id @default(cuid())
  attemptId        String
  questionId       String
  selectedOptionId String?
  isCorrect        Boolean
  attempt          QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question         QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOption   QuizOption?  @relation("SelectedOption", fields: [selectedOptionId], references: [id], onDelete: SetNull)

  @@unique([attemptId, questionId])
  @@index([attemptId])
}

enum AccountType {
  self
  family
}

enum AuthMethod {
  email
  phone
  google
}

enum ContentType {
  LONG
  SHORT
}
